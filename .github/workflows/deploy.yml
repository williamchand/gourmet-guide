name: Deploy

on:
  push:
    tags:
      - "v*"
  release:
    types: [published]
  workflow_dispatch:

env:
  TF_IN_AUTOMATION: true

jobs:
  build_backend:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      image_uri: ${{ steps.image.outputs.image_uri }}
    steps:
      - uses: actions/checkout@v4

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - id: image
        run: |
          IMAGE_TAG="${GITHUB_REF_NAME:-${GITHUB_SHA}}"
          IMAGE_URI="${{ vars.DOCKER_REGISTRY }}:${IMAGE_TAG}"
          echo "image_uri=${IMAGE_URI}" >> "$GITHUB_OUTPUT"

      - run: docker build -t "${{ steps.image.outputs.image_uri }}" backend

      - run: docker push "${{ steps.image.outputs.image_uri }}"

  terraform_apply:
    runs-on: ubuntu-latest
    needs: build_backend
    permissions:
      contents: read
      id-token: write
    outputs:
      frontend_bucket: ${{ steps.outputs.outputs.frontend_bucket }}
    steps:
      - uses: actions/checkout@v4

      - id: gcp_auth
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - uses: google-github-actions/setup-gcloud@v2

      - uses: hashicorp/setup-terraform@v3

      - working-directory: infra
        env:
          TF_VAR_project_id: ${{ vars.GCP_PROJECT_ID }}
          TF_VAR_environment: ${{ vars.DEPLOY_ENVIRONMENT }}
          TF_VAR_region: ${{ vars.GCP_REGION }}
          TF_VAR_backend_image: ${{ needs.build_backend.outputs.image_uri }}
          TF_VAR_allow_unauthenticated: "true"
        run: |
          terraform init
          terraform apply -auto-approve

      - id: outputs
        working-directory: infra
        run: |
          echo "frontend_bucket=$(terraform output -raw frontend_bucket)" >> "$GITHUB_OUTPUT"

  deploy_frontend:
    runs-on: ubuntu-latest
    needs: terraform_apply
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: npm
          cache-dependency-path: frontend/package.json

      - working-directory: frontend
        run: npm ci

      - working-directory: frontend
        run: npm run build

      - id: gcp_auth
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - uses: google-github-actions/setup-gcloud@v2

      - run: gcloud storage rsync --recursive --delete-unmatched-destination-objects frontend/dist "gs://${{ needs.terraform_apply.outputs.frontend_bucket }}"
