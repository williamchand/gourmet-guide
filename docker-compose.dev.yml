version: "3.9"

services:
  firestore-emulator:
    image: mtlynch/firestore-emulator:latest
    container_name: gourmetguide-firestore-emulator
    ports:
      - "8081:8080"
    environment:
      FIRESTORE_PROJECT_ID: gourmet-guide-local
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:8080/"]
      interval: 5s
      timeout: 3s
      retries: 20

  storage-emulator:
    image: fsouza/fake-gcs-server:1.52
    container_name: gourmetguide-storage-emulator
    command:
      - -scheme
      - http
      - -port
      - "4443"
      - -public-host
      - localhost:4443
      - -backend
      - memory
    ports:
      - "4443:4443"
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:4443/storage/v1/b"]
      interval: 5s
      timeout: 3s
      retries: 20

  storage-bootstrap:
    image: curlimages/curl:8.12.1
    container_name: gourmetguide-storage-bootstrap
    depends_on:
      storage-emulator:
        condition: service_healthy
    restart: "no"
    entrypoint:
      - sh
      - -c
      - |
        set -e
        curl -sS -X POST "http://storage-emulator:4443/storage/v1/b" \
          -H "Content-Type: application/json" \
          -d '{"name":"gourmet-guide-seed-local"}' || true
        echo "Bucket bootstrap finished"
